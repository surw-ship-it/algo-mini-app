<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>USDT ADS</title>

<!-- Telegram Mini App SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Monetag SDK -->
<script src="//libtl.com/sdk.js"
        data-zone="10483596"
        data-sdk="show_10483596"></script>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  background:#0f172a;
  color:#fff;
  font-family:Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.card {
  background:#020617;
  padding:20px;
  width:320px;
  border-radius:12px;
  text-align:center;
  position:relative;
}
button {
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
}
#adBtn { background:#2563eb; color:#fff; }
#withdrawBtn {
  position:absolute;
  top:10px;
  right:10px;
  width:auto;
  padding:6px 10px;
  font-size:13px;
}
</style>
</head>

<body>

<div class="card">
  <h2>USDT ADS</h2>
  <div>Bakiye: <b><span id="balance">0.000</span> USDT</b></div>
  <div>Reklam: <span id="counter">0</span> / 5</div>

  <button id="adBtn">ðŸŽ¬ Reklam Ä°zle</button>
  <button id="withdrawBtn">ðŸ’° Ã‡ekim</button>
</div>

<script>
/* ===== SUPABASE ===== */
const SUPABASE_URL = "https://laaozqlespqxqxtejywf.supabase.co";
const SUPABASE_KEY = "ANON_KEYÄ°N_DEÄžÄ°ÅžMEDÄ°";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

/* ===== TELEGRAM ===== */
Telegram.WebApp.ready();
Telegram.WebApp.expand();

const tg = Telegram.WebApp.initDataUnsafe.user;
if (!tg) {
  alert("Telegram user yok");
  throw new Error("Telegram user yok");
}

const telegram_id = tg.id.toString();
const username = tg.username ?? null;

/* ===== STATE ===== */
let adCount = 0;
let balance = 0;

/* ===== INIT USER ===== */
async function init() {
  const { data } = await supabase
    .from("users")
    .select("*")
    .eq("telegram_id", telegram_id)
    .maybeSingle();

  if (!data) {
    await supabase.from("users").insert({
      telegram_id,
      username,
      balance: 0,
      total_ads: 0
    });
    balance = 0;
    adCount = 0;
  } else {
    balance = Number(data.balance);
    adCount = data.total_ads % 5;
  }

  updateUI();
}

function updateUI() {
  document.getElementById("balance").innerText = balance.toFixed(3);
  document.getElementById("counter").innerText = adCount;
}

/* ===== AD BUTTON (TELEGRAM UYUMLU) ===== */
document.getElementById("adBtn").onclick = async () => {

  // Monetag reklamÄ± yeni pencerede aÃ§
  const adWindow = window.open(
    "https://libtl.com/sdk/10483596",
    "_blank"
  );

  if (!adWindow) {
    alert("Reklam aÃ§Ä±lamadÄ±");
    return;
  }

  // Pencere kapatÄ±lÄ±nca Ã¶dÃ¼l ver
  const watcher = setInterval(async () => {
    if (adWindow.closed) {
      clearInterval(watcher);

      adCount++;

      await supabase.from("ad_views").insert({
        telegram_id
      });

      const { data } = await supabase
        .from("users")
        .select("balance,total_ads")
        .eq("telegram_id", telegram_id)
        .single();

      let totalAds = data.total_ads + 1;
      balance = Number(data.balance);

      if (adCount >= 5) {
        balance += 0.005;
        adCount = 0;
        alert("+0.005 USDT kazandÄ±n ðŸŽ‰");
      }

      await supabase.from("users").update({
        balance,
        total_ads: totalAds
      }).eq("telegram_id", telegram_id);

      updateUI();
    }
  }, 500);
};

/* ===== WITHDRAW ===== */
document.getElementById("withdrawBtn").onclick = async () => {
  const wallet = prompt("CÃ¼zdan adresi:");
  if (!wallet) return;

  if (balance <= 0) {
    alert("Bakiye yok");
    return;
  }

  await supabase.from("withdrawals").insert({
    telegram_id,
    wallet_address: wallet,
    amount: balance,
    status: "pending"
  });

  balance = 0;
  await supabase.from("users")
    .update({ balance: 0 })
    .eq("telegram_id", telegram_id);

  updateUI();
  alert("Ã‡ekim talebi alÄ±ndÄ± âœ…");
};

init();
</script>

</body>
</html>
