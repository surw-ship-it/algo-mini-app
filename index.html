<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>USDT ADS Mini App</title>

<!-- Telegram Mini App SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Monetag SDK -->
<script src="//libtl.com/sdk.js"
        data-zone="10483596"
        data-sdk="show_10483596"></script>

<!-- Bolt Database SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/Bolt Database-js@2"></script>

<style>
body {
  margin: 0;
  padding: 0;
  background: #0f172a;
  color: #fff;
  font-family: Arial, Helvetica, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.card {
  width: 90%;
  max-width: 360px;
  background: #020617;
  border-radius: 14px;
  padding: 20px;
  text-align: center;
  position: relative;
}
h1 { font-size: 20px; }
.balance { font-size: 18px; margin: 15px 0; color: #22c55e; }
button {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  background: #2563eb;
  color: #fff;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  margin-top: 8px;
}
button:active {
  background: #1d4ed8;
}
.counter { font-size: 14px; margin: 10px 0; color: #facc15; }
.counter-info { font-size: 13px; color: #f87171; }
#withdrawBtn {
  position: absolute;
  top: 10px;
  right: 10px;
  width: auto;
  padding: 6px 12px;
  font-size: 14px;
}
#withdrawPopup {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 999;
}
.popup-content {
  background: #020617;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 300px;
}
.popup-content input {
  width: 100%;
  padding: 10px;
  margin: 10px 0;
  box-sizing: border-box;
  background: #1e293b;
  border: 1px solid #334155;
  color: #fff;
  border-radius: 6px;
}
.popup-content h3 {
  margin-top: 0;
}
.debug {
  font-size: 12px;
  color: #ef4444;
  margin-top: 10px;
  text-align: left;
  background: #1e1b4b;
  padding: 8px;
  border-radius: 4px;
}
</style>
</head>

<body>

<div class="card">
  <h1>USDT ADS</h1>
  <p>Reklam izle, USDT kazan</p>

  <div class="balance">
    Bakiye: <span id="balance">0.000</span> USDT
  </div>

  <div class="counter-info">5 reklam izle 0.005$ kazan</div>
  <div class="counter">
    Reklam sayacƒ±: <span id="adCounterDisplay">0</span> / 5
  </div>

  <button id="adBtn">üé¨ Reklam ƒ∞zle</button>
  <button id="withdrawBtn">üí∞ √áekim Talebi</button>
  
  <div class="debug" id="debug"></div>
</div>

<div id="withdrawPopup">
  <div class="popup-content">
    <h3>√áekim Talebi</h3>
    <input id="walletAddress" placeholder="C√ºzdan adresi" />
    <button id="submitWithdraw">G√∂nder</button>
    <button id="cancelWithdraw">ƒ∞ptal</button>
  </div>
</div>

<script>
/* ================== DEBUG ================== */
const debugEl = document.getElementById("debug");
function debug(msg) {
  console.log(msg);
  debugEl.innerText = msg;
}

try {
  debug("Ba≈ülatƒ±lƒ±yor...");

  /* ================== TELEGRAM ================== */
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();

  const tgUser = Telegram.WebApp.initDataUnsafe.user;
  if (!tgUser) {
    debug("‚ùå Telegram kullanƒ±cƒ±sƒ± alƒ±namadƒ±!");
    throw new Error("Telegram user not found");
  }
  
  const telegramId = tgUser.id;
  debug(`‚úì Telegram ID: ${telegramId}`);

  /* ================== Bolt Database ================== */
  const Bolt Database = window.supabase.createClient(
    "https://slfiayhyouktjoakvhcu.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZmlheWh5b3VrdGpvYWt2aGN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxODg5ODEsImV4cCI6MjA4NDc2NDk4MX0.d1aEuVzcaf_4l8YTvbdv0cy0S32tniK3N1QzK4a8GpM"
  );
  debug("‚úì Bolt Database baƒülandƒ±");

  /* ================== ELEMENTLER ================== */
  const adBtn = document.getElementById("adBtn");
  const withdrawBtn = document.getElementById("withdrawBtn");
  const withdrawPopup = document.getElementById("withdrawPopup");
  const submitWithdraw = document.getElementById("submitWithdraw");
  const cancelWithdraw = document.getElementById("cancelWithdraw");
  const walletAddress = document.getElementById("walletAddress");
  const balanceEl = document.getElementById("balance");
  const counterEl = document.getElementById("adCounterDisplay");

  /* ================== STATE ================== */
  let balance = 0;
  let totalAds = 0;
  let adCounter = 0;
  const adsPerReward = 5;
  const rewardAmount = 0.005;

  /* ================== USER INIT ================== */
  async function initUser() {
    try {
      debug("Kullanƒ±cƒ± verisi y√ºkleniyor...");
      
      const { data, error } = await Bolt Database
        .from("users")
        .select("*")
        .eq("telegram_id", telegramId)
        .maybeSingle();

      if (error) {
        debug(`‚ùå Hata: ${error.message}`);
        return;
      }

      if (!data) {
        debug("Yeni kullanƒ±cƒ± olu≈üturuluyor...");
        const { error: insertError } = await supabase.from("users").insert({
          telegram_id: telegramId,
          username: tgUser.username || "",
          first_name: tgUser.first_name || "",
          balance: 0,
          total_ads: 0
        });
        
        if (insertError) {
          debug(`‚ùå Insert hatasƒ±: ${insertError.message}`);
          return;
        }
      } else {
        balance = data.balance;
        totalAds = data.total_ads;
        adCounter = totalAds % adsPerReward;
        debug(`‚úì Kullanƒ±cƒ± y√ºklendi (Bakiye: ${balance} USDT)`);
      }

      balanceEl.innerText = balance.toFixed(3);
      counterEl.innerText = adCounter;
    } catch (err) {
      debug(`‚ùå Hata: ${err.message}`);
    }
  }

  /* ================== BUTTON EVENTS ================== */
  adBtn.addEventListener("click", async () => {
    try {
      if (typeof show_10483596 !== "function") {
        debug("‚ùå Reklam sistemi y√ºklenmedi");
        alert("Reklam sistemi hazƒ±r deƒüil");
        return;
      }

      debug("Reklam a√ßƒ±lƒ±yor...");
      
      await show_10483596();
      
      totalAds++;
      adCounter++;

      if (adCounter >= adsPerReward) {
        balance += rewardAmount;
        adCounter = 0;
        debug(`‚úì √ñd√ºl kazanƒ±ldƒ±! +${rewardAmount} USDT`);
      }

      const { error } = await supabase.from("users").update({
        balance: balance,
        total_ads: totalAds
      }).eq("telegram_id", telegramId);

      if (error) {
        debug(`‚ùå Update hatasƒ±: ${error.message}`);
        return;
      }

      balanceEl.innerText = balance.toFixed(3);
      counterEl.innerText = adCounter;
      debug("‚úì Veriler g√ºncellendi");
    } catch (err) {
      debug(`‚ùå Reklam hatasƒ±: ${err.message}`);
    }
  });

  withdrawBtn.addEventListener("click", () => {
    debug("√áekim popup a√ßƒ±lƒ±yor...");
    withdrawPopup.style.display = "flex";
  });

  cancelWithdraw.addEventListener("click", () => {
    withdrawPopup.style.display = "none";
    debug("ƒ∞ptal");
  });

  submitWithdraw.addEventListener("click", async () => {
    try {
      const wallet = walletAddress.value.trim();
      if (!wallet) {
        debug("‚ùå C√ºzdan adresi bo≈ü");
        alert("C√ºzdan adresi girin");
        return;
      }

      debug("√áekim talebi g√∂nderiliyor...");

      const { error } = await supabase.from("withdraw_requests").insert({
        telegram_id: telegramId,
        wallet: wallet,
        amount: balance
      });

      if (error) {
        debug(`‚ùå √áekim hatasƒ±: ${error.message}`);
        return;
      }

      debug("‚úì √áekim talebi alƒ±ndƒ±");
      alert("√áekim talebi g√∂nderildi!");
      walletAddress.value = "";
      withdrawPopup.style.display = "none";
      balance = 0;
      balanceEl.innerText = balance.toFixed(3);
    } catch (err) {
      debug(`‚ùå Hatasƒ±: ${err.message}`);
    }
  });

  /* ================== START ================== */
  initUser();

} catch (err) {
  debug(`‚ùå KRITIK HATA: ${err.message}`);
}
</script>

</body>
</html>
